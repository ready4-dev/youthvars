library(ready4fun)
ready4fun::write_fn_type_dirs() # Need to ammend to write empty generics.R file
# MANUAL STEP. Write all your functions to R files in the new "fns" directory.
fns_env_ls <- ready4fun::read_fns(c("data-raw/fns/","data-raw/mthds/"),
                                  fns_env = new.env(parent = globalenv()))
x_ready4fun_manifest <- ready4fun::make_pkg_desc_ls(pkg_title_1L_chr = "Describe Variables Used To Characterize Youth Populations",
                                                    pkg_desc_1L_chr = "Tools to describe and summarise types of data commonly present in youth mental health collections.
                            The main motivation for this package is to facilitate automated data integrity checks, ensure that methods are applied to the appropriate data structures and streamline reporting of descriptive statistics.
  This development version of the youthvars package has been made available as part of the process of testing and documenting the package. The documentation for this package has been automatically generated by the ready4fun package and is therefore quite rudimentary. Human authored documentation will follow in 2021.
                            If you have any questions, please contact the authors (matthew.hamilton@orygen.org.au).",
                                                    authors_prsn = c(utils::person(given = "Matthew",family = "Hamilton",email = "matthew.hamilton@orygen.org.au", role = c("aut", "cre"),comment = c(ORCID = "0000-0001-7407-9194")),
                                                                     utils::person(given = "Caroline",family = "Gao",email = "caroline.gao@orygen.org.au", role = c("aut"),comment = c(ORCID = "0000-0002-0987-2759")),
                                                                     utils::person("Orygen", role = c("cph", "fnd")),
                                                                     utils::person("Headspace", role = c( "fnd")),
                                                                     utils::person("National Health and Medical Research Council", role = c( "fnd"))),
                                                    urls_chr = c("https://ready4-dev.github.io/youthvars/",
                                                                 "https://github.com/ready4-dev/youthvars",
                                                                 "https://ready4-dev.github.io/ready4/")) %>%
  ready4fun::make_manifest(addl_pkgs_ls = ready4fun::make_addl_pkgs_ls(suggests_chr = "rmarkdown",
                                                                       imports_chr = "knitrBootstrap"),
                           build_ignore_ls = ready4fun::make_build_ignore_ls(file_nms_chr = c("initial_setup.R")),
                           check_type_1L_chr = "ready4",
                           copyright_holders_chr = "Orygen",
                           custom_dmt_ls = ready4fun::make_custom_dmt_ls(user_manual_fns_chr = c("add_adol6d_scores",
                                                                                                 "add_interval_var",
                                                                                                 "add_participation_var",
                                                                                                 "assert_ds_is_valid",
                                                                                                 "make_corstars_tbl_xx",
                                                                                                 "make_descv_stats_tbl",
                                                                                                 "make_final_repln_ds_dict",
                                                                                                 "make_formula",
                                                                                                 "make_itm_resp_plts",
                                                                                                 "make_sub_tot_plts",
                                                                                                 "make_tfd_repln_ds_dict_r3",
                                                                                                 "make_var_by_round_plt",
                                                                                                 "print_descv_stats_tbl",
                                                                                                 "transform_ds_for_tstng",
                                                                                                 "transform_raw_ds_for_analysis",
                                                                                                 "write_all_outp_dirs",
                                                                                                 "write_desv_plots",
                                                                                                 "write_descv_tbls")),##
                           dev_pkgs_chr = c("ready4fun","ready4class","ready4use","ready4show"),
                           lifecycle_stage_1L_chr = "experimental",
                           path_to_pkg_logo_1L_chr = "../../../../../Documentation/Images/youthvars-logo/default.png",
                           pkg_dmt_dv_dss_chr = c("https://doi.org/10.7910/DVN/HLLXZN",
                                                  "https://doi.org/10.7910/DVN/2Y9VF9"),
                           ready4_type_1L_chr = "authoring")
x_ready4class_constructor <- ready4class::ready4class_constructor() %>%
  dplyr::bind_rows(tibble::tribble(
    ~ make_s3_lgl, ~ name_stub_chr, ~ pt_ls, ~ pt_chkr_pfx_ls, ~ pt_ns_ls, ~ vals_ls, ~ allowed_vals_ls, ~ min_max_vals_ls, ~ start_end_vals_ls, ~ class_desc_chr, ~ parent_class_chr, ~ slots_ls, ~ meaningful_nms_ls, ~ inc_clss_ls, ~ asserts_ls,
    TRUE, "aqol6d_adol", list("numeric"), list("is."),list("base"), NULL, NULL,list(c(0.03, 1)), NULL, "youthvars S3 class for Assessment of Quality of Life Six Dimension Health Utility - Adolescent Version (AQoL6d Adolescent))", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "phq9", list("integer"), list("is."),list("base"), NULL, NULL,list(c(0, 27)), NULL, "youthvars S3 class for Patient Health Questionnaire (PHQ-9) scores", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "bads", list("integer"), list("is."),list("base"), NULL, NULL,list(c(0, 150)), NULL, "youthvars S3 class for Behavioural Activation for Depression Scale (BADS) scores", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "gad7", list("integer"), list("is."),list("base"), NULL, NULL,list(c(0, 21)), NULL, "youthvars S3 class for Generalised Anxiety Disorder Scale (GAD-7) scores", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "oasis", list("integer"), list("is."),list("base"), NULL, NULL,list(c(0, 20)), NULL, "youthvars S3 class for Overall Anxiety Severity and Impairment Scale (OASIS) scores", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "scared", list("integer"), list("is."),list("base"),NULL, NULL,list(c(0, 82)), NULL, "youthvars S3 class for Screen for Child Anxiety Related Disorders (SCARED) scores", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "k6", list("integer"), list("is."),list("base"), NULL, NULL,list(c(0, 24)), NULL, "youthvars S3 class for Kessler Psychological Distress Scale (K6) - US Scoring System scores", NA_character_, NULL, NULL, NULL, NULL,
    TRUE, "sofas", list("integer"), list("is."),list("base"), NULL, NULL,list(c(0, 100)), NULL, "youthvars S3 class for Social and Occupational Functioning Assessment Scale (SOFAS)", NA_character_, NULL, NULL, NULL, NULL))
replication_popl_tb <- read.csv("data-raw/csvs/fake_pop_tb.csv") %>%
  dplyr::mutate(c_sofas = as.integer(round(c_sofas,0))) %>%
  dplyr::mutate(round = factor(round, labels = c("Baseline",
                                                 "Follow-up"))) %>%
  dplyr::mutate(d_relation_s = dplyr::case_when(d_relation_s %in% c("REPLACE_ME_1","REPLACE_ME_2") ~ "Not in a relationship",
                                                T ~ "In a relationship")) %>%
  add_dates_from_dstr(bl_start_date_dtm = Sys.Date() - lubridate::days(600),##
                              bl_end_date_dtm = Sys.Date() - lubridate::days(420),
                              duration_args_ls = list(a = 60, b = 140, mean = 90, sd = 10),
                              duration_fn = truncnorm::rtruncnorm,
                              date_var_nm_1L_chr = "d_interview_date") %>%
  dplyr::select(-duration_prd) %>%
  fns_env_ls$fns_env$transform_raw_ds_for_analysis() %>%
  dplyr::rename(phq9_total = PHQ9,
                bads_total = BADS,
                gad7_total = GAD7,
                oasis_total = OASIS,
                scared_total = SCARED,
                k6_total = K6,
                c_sofas = SOFAS)
scored_data_tb <- fns_env_ls$fns_env$add_adol6d_scores(replication_popl_tb,
                                    prefix_1L_chr = "aqol6d_q",
                                    id_var_nm_1L_chr = "fkClientID",
                                    wtd_aqol_var_nm_1L_chr = "aqol6d_total_w",
                                    total_aqol_var_nm_1L_chr = "aqol6d_total_c")
Hmisc::label(scored_data_tb[["aqol6d_total_c"]]) <- "AQOL-6D (unweighted total)"
Hmisc::label(scored_data_tb[["aqol6d_total_w"]]) <- "AQOL-6D (weighted total)"
dictionary_tb <- ready4use::make_pt_ready4use_dictionary(var_nm_chr = names(scored_data_tb),
                                                      var_ctg_chr = c("identifier","temporal","temporal",
                                                                      rep("demographic",14),
                                                                      "service provider",
                                                                      rep("clinical symptom",2),
                                                                      c("psychological distress",
                                                                        rep("depression",2),
                                                                        rep("anxiety",3)),
                                                                      "functioning",
                                                                      #rep("Demographic",3),
                                                                      rep("multi-attribute utility instrument question",20),
                                                                      rep("utility item disvalue",20),
                                                                      rep("utility dimension disvalue",6),
                                                                      rep("utility dimension score (adult)",6),
                                                                      "utility overall score (disvalue scale)",
                                                                      "utility overall score (life-death scale)",
                                                                      rep("utility overall score (adolescent disutility scale)",2), # Includes Testing Duplicate
                                                                      "utility overall score (instrument)",
                                                                      "utility overall score (instrument - rotated)",
                                                                      "utility overall score (final weighted)",
                                                                      "multi-attribute utility instrument unweighted total score"
                                                      ),
                                                      var_desc_chr = c("unique client identifier",
                                                                       "round of data collection",
                                                                       "date of data collection",
                                                                       "age",
                                                                       "age Group",
                                                                       "gender (grouped)",
                                                                       "gender",
                                                                       "sex at birth",
                                                                       "sexual orientation",
                                                                       "Aboriginal or Torres Strait Islander",
                                                                       "Culturally And Linguistically Diverse",
                                                                       "country Of birth",
                                                                       "speaks English at home",
                                                                       "native English speaker",
                                                                       "region of residence (metropolitan or regional)",
                                                                       "education and employment status",
                                                                       "relationship status",
                                                                       "service centre name",
                                                                       "primary diagnosis",
                                                                       "clinical stage",
                                                                       "Kessler Psychological Distress Scale (6 Dimension)",
                                                                       "Patient Health Questionnaire",
                                                                       "Behavioural Activation for Depression Scale",
                                                                       "Generalised Anxiety Disorder Scale",
                                                                       "Overall Anxiety Severity and Impairment Scale",
                                                                       "Screen for Child Anxiety Related Disorders",
                                                                       "Social and Occupational Functioning Assessment Scale",
                                                                       paste0("Assessment of Quality of Life (6 Dimension) question ",1:20),
                                                                       paste0("Assessment of Quality of Life (6 Dimension) item disvalue",1:20),
                                                                       lapply(scored_data_tb, Hmisc::label) %>% purrr::flatten_chr() %>% purrr::keep(c(rep(F,67),rep(T,20)))
                                                      ),
                                                      var_type_chr = names(scored_data_tb) %>% purrr::map_chr(~{
                                                        class_chr <- class(scored_data_tb %>% dplyr::pull(.x))
                                                        class_chr[class_chr!="labelled"][1]
                                                      })) %>% ready4use::ready4use_dictionary()
Hmisc::label(dictionary_tb) = as.list(c("Variable","Category", "Description", "Class"))
dictionary_tb <- dictionary_tb %>%
  dplyr::arrange(var_ctg_chr,var_nm_chr)
datasets_ls <- list(tibble::tribble(
  ~var_name_chr, ~coef_dbl,
  "vD1", 0.0719264,
  "vD2", 0.1027818,
  "vD3", 0.2519563,
  "vD4", 0.3201172,
  "vD5", 0.1288289,
  "vD6", 0.2052164,
  "Constant", - 0.0444493
) %>% ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol6d_from_8d_coefs_lup_tb",
                                                title_1L_chr = "Model 2A Coefficients To Weight AQoL6D",
                                                desc_1L_chr = "Coefficients for model to predict AQoL-6D utility score from AQoL-8D. The optimal model is Model 2A (see Richardson et al (2011, 18-19)*/",
                                                url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),
tibble::tribble(
  ~Question_chr, ~Answer_1_dbl, ~Answer_2_dbl, ~Answer_3_dbl, ~Answer_4_dbl, ~Answer_5_dbl, ~Answer_6_dbl,
  "Q1", 0, 0.073, 0.435, 0.820, 1, NA_real_,
  "Q2", 0, 0.033, 0.240, 0.471, 0.840,1,
  "Q3", 0, 0.041, 0.251, 0.570, 0.830, 1,
  "Q4", 0, 0.040, 0.297, 0.797, 1, NA_real_,
  "Q5", 0, 0.074, 0.461, 0.841, 1, NA_real_,
  "Q6", 0, 0.193, 0.759, 1, NA_real_,NA_real_,
  "Q7", 0, 0.197, 0.648, 1, NA_real_, NA_real_,
  "Q8", 0, 0.133, 0.392, 0.838, 1, NA_real_,
  "Q9", 0, 0.142, 0.392, 0.824, 1, NA_real_,
  "Q10", 0, 0.097, 0.330, 0.784, 1, NA_real_,
  "Q11", 0, 0.064, 0.368, 0.837, 1, NA_real_,
  "Q12", 0, 0.056, 0.338, 0.722, 1, NA_real_,
  "Q13", 0, 0.055, 0.382, 0.774, 1, NA_real_,
  "Q14", 0, 0.057, 0.423, 0.826, 1, NA_real_,
  "Q15", 0, 0.133, 0.642, 1, NA_real_,NA_real_,
  "Q16", 0, 0.200, 0.758, 1, NA_real_, NA_real_,
  "Q17", 0, 0.072, 0.338, 0.752, 1, NA_real_,
  "Q18", 0, 0.033, 0.223, 0.621, 0.843, 1,
  "Q19", 0, 0.024, 0.205, 0.586, 0.826, 1,
  "Q20", 0, 0.187, 0.695, 1, NA_real_,NA_real_
) %>% ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol6d_adult_disv_lup_tb",
                                  title_1L_chr = "AQoL6D (adult version) item disvalues lookup table",
                                  desc_1L_chr = "Disutility weights for individual AQoL6D (adult version) items.",
                                  url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),
tibble::tibble(Question_dbl = 1:20,
               Domain_chr = c(rep("IL",4),
                              rep("REL",3),
                              rep("MH",4),
                              rep("COP",3),
                              rep("P",3),
                              rep("SEN",3))) %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol6d_domain_qs_lup_tb",
                              title_1L_chr = "AQoL6D dimension questions lookup table",
                              desc_1L_chr = "Breakdown of which questions relate to which dimension of the AQoL6D.",
                              url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),
tibble::tribble(
  ~Dimension_chr, ~Constant_dbl,
  "IL",-0.978,
  "RL", -0.923,
  "MH", -0.983,
  "COP", -0.930,
  "P", -0.96,
  "SEN", -0.851) %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol6d_dim_sclg_con_lup_tb",
                                                 title_1L_chr = "AQoL6D dimension scaling constants lookup table",
                                                 desc_1L_chr = "Scaling constants for each dimension of AQoL6D.",
                                                 url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),
tibble::tribble(
  ~Question_chr, ~Worst_Weight_dbl,
  "Q1", 0.385412,
  "Q2", 0.593819,
  "Q3", 0.630323,
  "Q4", 0.794888,
  "Q5", 0.64303,
  "Q6", 0.697742,
  "Q7", 0.508658,
  "Q8", 0.640377,
  "Q9", 0.588422,
  "Q10", 0.648748,
  "Q11", 0.71122,
  "Q12", 0.415694,
  "Q13", 0.636994,
  "Q14", 0.773296,
  "Q15", 0.631833,
  "Q16", 0.767573,
  "Q17", 0.652241,
  "Q18", 0.580696,
  "Q19", 0.463022,
  "Q20", 0.604613
) %>% ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol6d_adult_itm_wrst_wts_lup_tb",
                                  title_1L_chr = "AQoL6D (adult) item worst weightings lookup table",
                                  desc_1L_chr = "Worst weightings for individual items in AQoL6D (adult version).",
                                  url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),

read.csv("data-raw/csvs/AQoL_6D_Dim_Scaling.csv", stringsAsFactors = F, fileEncoding="UTF-8-BOM") %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "adol_dim_scalg_eqs_lup",
                              title_1L_chr = "AQoL6D (adolescent) item worst weightings equations lookup table",
                              desc_1L_chr = "Dimension scaling equations for adolescent version of AQoL6D scoring algorithm.",
                              url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),
read.csv("data-raw/csvs/aqol_valid_stata.csv") %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol6d_adult_vldn_pop_with_STATA_scores_tb",
                              title_1L_chr = "STATA comparison validation synthetic population",
                              desc_1L_chr = "Synthetic population following application of STATA adult scoring algorithm.",
                              url_1L_chr = "https://www.aqol.com.au/index.php/scoring-algorithms"),

dictionary_tb %>%
  dplyr::filter(var_nm_chr %in% names(replication_popl_tb)) %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "repln_ds_dict_r3",
                              title_1L_chr = "Data dictionary for study population dataset",
                              desc_1L_chr = "A data dictionary of the variables used in the source and replication (synthetic) datasets for the First Bounce transfer to utility study"),
dictionary_tb %>%
  dplyr::filter((!var_nm_chr %in% names(replication_popl_tb)) | startsWith(var_nm_chr, "aqol")) %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "aqol_scrg_dict_r3",
                              title_1L_chr = "Data dictionary for AQoL scoring",
                              desc_1L_chr = "A data dictionary of the variables used in scoring AQoL 6D utility questionnaire responses."),
replication_popl_tb %>%
  dplyr::select(-c(d_agegroup,Gender, CALD, Region)) %>%
  #add_labels_from_dictionary(dictionary_tb = dictionary_tb) %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "replication_popl_tb",
                              title_1L_chr = "Synthetic population replication dataset",
                              desc_1L_chr = "A purely synthetic dataset, representative of the original study data, that can be used for replication runs of package algorithms.",
                              abbreviations_lup = tibble::tibble(short_name_chr = dictionary_tb$var_nm_chr,
                                                                 long_name_chr = dictionary_tb$var_desc_chr,
                                                                 plural_lgl = F),
                            simple_lup_1L_lgl = T),
tibble::tibble(short_name_chr = c("BADS","GAD7","K6","OASIS","PHQ9","SCARED","SOFAS"),
               long_name_chr = short_name_chr %>% purrr::map_chr(~paste0(.x, " total score")),
               min_val_dbl = rep(0,7),
               max_val_dbl = c(150,21,24,20,27,82,100),
               class_chr = "integer",
               increment_dbl = rep(1,7),
               class_fn_chr = paste0("youthvars::youthvars_",tolower(short_name_chr)),
               mdl_scaling_dbl = 0.01,
               covariate_lgl = c(rep(F,6),T)) %>%
  ready4fun::make_pkg_ds_ls(db_1L_chr = "predictors_lup",
                              title_1L_chr = "Predictors lookup table",
                              desc_1L_chr = "A lookup table of the short name and long name of each predictor used in the models included with the youthu package.")

)
x_ready4use_manifest <- ready4use::make_pt_ready4use_manifest(x_ready4fun_manifest,
                                                              constructor_r3 = x_ready4class_constructor,
                                                              pkg_ds_ls_ls = datasets_ls) %>%
  ready4use::ready4use_manifest()
x_xx <- ready4fun::author(x_ready4use_manifest)
